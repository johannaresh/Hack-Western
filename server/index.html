<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Workout Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        background: #fafafa;
        color: #222;
        padding: 40px 20px;
        line-height: 1.5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
      }

      h1 {
        font-size: 32px;
        font-weight: 700;
        color: #111;
      }

      .session-info {
        text-align: right;
      }

      .session-time {
        font-size: 24px;
        font-weight: 600;
        color: #111;
      }

      .session-label {
        font-size: 13px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e5e5e5;
      }

      .card h2 {
        font-size: 13px;
        font-weight: 600;
        color: #888;
        margin-bottom: 16px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .rep-number {
        font-size: 64px;
        font-weight: 700;
        color: #111;
        line-height: 1;
        margin: 12px 0;
      }

      .rep-label {
        color: #888;
        font-size: 14px;
      }

      .stats {
        display: flex;
        gap: 16px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #f0f0f0;
      }

      .stat {
        flex: 1;
      }

      .stat-value {
        font-size: 20px;
        font-weight: 600;
        color: #111;
      }

      .stat-label {
        font-size: 12px;
        color: #888;
        margin-top: 4px;
      }

      .video-section {
        grid-column: span 3;
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
      }

      video {
        width: 100%;
        height: 400px;
        border-radius: 8px;
        background: #000;
        object-fit: cover;
      }

      .status {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #666;
        margin-top: 12px;
      }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #22c55e;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
      }

      .meta {
        font-size: 11px;
        color: #aaa;
        margin-top: 8px;
        font-family: 'Courier New', monospace;
      }

      .activity-feed {
        max-height: 400px;
        overflow-y: auto;
      }

      .activity-item {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 13px;
      }

      .activity-item:last-child {
        border-bottom: none;
      }

      .activity-time {
        color: #aaa;
        font-size: 11px;
      }

      .activity-text {
        color: #555;
        margin-top: 4px;
      }

      .chart-container {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #f0f0f0;
      }

      .chart-label {
        font-size: 12px;
        color: #888;
        margin-bottom: 8px;
      }

      .bar-chart {
        display: flex;
        align-items: flex-end;
        gap: 4px;
        height: 60px;
      }

      .bar {
        flex: 1;
        background: #e5e5e5;
        border-radius: 3px 3px 0 0;
        transition: all 0.3s ease;
      }

      .bar.active {
        background: #3b82f6;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 20px;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background: #111;
        color: white;
      }

      .btn-primary:hover {
        background: #333;
      }

      .btn-secondary {
        background: #f5f5f5;
        color: #111;
        border: 1px solid #e5e5e5;
      }

      .btn-secondary:hover {
        background: #eee;
      }

      .btn:disabled {
        opacity: 0.4;
        cursor: default;
      }

      @media (max-width: 1024px) {
        .grid {
          grid-template-columns: repeat(2, 1fr);
        }
        
        .video-section {
          grid-column: span 2;
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
        }

        .video-section {
          grid-column: span 1;
        }

        .rep-number {
          font-size: 48px;
        }

        header {
          flex-direction: column;
          align-items: flex-start;
          gap: 16px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div>
          <h1>Workout Session</h1>
        </div>
        <div class="session-info">
          <div class="session-time" id="sessionTime">00:00</div>
          <div class="session-label">Session Time</div>
        </div>
      </header>

      <div class="grid">
        <!-- Gyroscope Card -->
        <div class="card">
          <h2>Gyroscope</h2>
          <div class="rep-number" id="gyroReps">0</div>
          <div class="rep-label">reps completed (this set)</div>
          
          <div class="chart-container">
            <div class="chart-label">Last 10 reps</div>
            <div class="bar-chart" id="gyroChart">
              <div class="bar" style="height: 0%"></div>
              <div class="bar" style="height: 0%"></div>
              <div class="bar" style="height: 0%"></div>
              <div class="bar" style="height: 0%"></div>
              <div class="bar" style="height: 0%"></div>
              <div class="bar" style="height: 0%"></div>
              <div class="bar" style="height: 0%"></div>
              <div class="bar" style="height: 0%"></div>
              <div class="bar" style="height: 0%"></div>
              <div class="bar active" style="height: 0%"></div>
            </div>
            <!-- Hover label for tempo -->
            <div class="chart-label" id="gyroTempoLabel" style="margin-top:6px;">
              Hover a bar to see rep tempo
            </div>
          </div>
        </div>

        <!-- Summary Card -->
        <div class="card">
          <h2>Summary</h2>
          <div class="stats">
            <div class="stat">
              <div class="stat-value" id="totalReps">0</div>
              <div class="stat-label">Total Reps (this set)</div>
            </div>
            <div class="stat">
              <div class="stat-value" id="avgMag">0.0</div>
              <div class="stat-label">Avg Mag</div>
            </div>
          </div>
          
          <div class="controls">
            <button class="btn btn-primary" id="startSetBtn">Start Set</button>
            <button class="btn btn-secondary" id="endSetBtn" disabled>End Set</button>
            <button class="btn btn-secondary" id="resetBtn">Reset Session</button>
          </div>
          <div class="stat-label" id="setStatus" style="margin-top:8px;">Not in a set</div>

          <div class="meta" id="meta">Waiting for data...</div>
        </div>

        <!-- Video Section -->
        <div class="video-section">
          <div class="card">
            <h2>Camera Feed</h2>
            <video id="cam" autoplay playsinline muted></video>
            <div class="status">
              <span class="dot"></span>
              <span id="camStatus">Connecting...</span>
            </div>
          </div>

          <div class="card">
            <h2>Activity Log</h2>
            <div class="activity-feed" id="activityFeed">
              <div class="activity-item">
                <div class="activity-time">--:--:--</div>
                <div class="activity-text">Waiting for activity...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

        <script>
      // --- Session timer ---
      let sessionStart = Date.now();
      setInterval(() => {
        const elapsed = Math.floor((Date.now() - sessionStart) / 1000);
        const mins = Math.floor(elapsed / 60);
        const secs = elapsed % 60;
        document.getElementById('sessionTime').textContent = 
          `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      }, 1000);

      // --- Activity log ---
      let activityLog = [];
      function addActivity(text) {
        const time = new Date().toLocaleTimeString();
        activityLog.unshift({ time, text });
        if (activityLog.length > 20) activityLog.pop();
        
        const feed = document.getElementById('activityFeed');
        feed.innerHTML = activityLog.map(item => 
          `<div class="activity-item">
            <div class="activity-time">${item.time}</div>
            <div class="activity-text">${item.text}</div>
          </div>`
        ).join('');
      }

      // --- Chart data (store height + tempo + repIndex per bar) ---
      let gyroHistory = []; // [{height, tempoMs, repIndex}, ...]
      let magHistory = [];

      function updateChart(chartId, history) {
        const bars = document.querySelectorAll(`#${chartId} .bar`);
        const tempoLabel = document.getElementById('gyroTempoLabel');

        bars.forEach((bar, i) => {
          const item = history[i];
          const height = item ? item.height : 0;
          const tempoMs = item ? item.tempoMs : null;
          const repIndex = item ? item.repIndex : null;

          bar.style.height = `${height}%`;
          bar.classList.toggle('active', i === history.length - 1 && history.length > 0);

          if (repIndex != null) {
            if (tempoMs != null) {
              const seconds = (tempoMs / 1000).toFixed(2);
              bar.title = `Rep ${repIndex}: ${seconds}s`;
            } else {
              bar.title = `Rep ${repIndex}: N/A`;
            }
          } else {
            bar.removeAttribute('title');
          }
        });

        if (history.length === 0) {
          tempoLabel.textContent = 'Hover a bar to see rep tempo';
        }
      }

      // Map tempo (ms) to a bar height in %
      function tempoToHeight(tempoMs) {
        if (typeof tempoMs !== "number") return 50; // default mid-height

        const minMs = 400;
        const maxMs = 3000;
        const clamped = Math.max(minMs, Math.min(maxMs, tempoMs));
        const fraction = (clamped - minMs) / (maxMs - minMs); // 0 (fast) â†’ 1 (slow)

        return 20 + 80 * fraction;
      }

      // --- Set tracking state ---
      let ws = null;
      let currentGyroTotal = 0;
      let setActive = false;
      let baseGyroTotal = 0;

      const startSetBtn = document.getElementById('startSetBtn');
      const endSetBtn = document.getElementById('endSetBtn');
      const setStatusEl = document.getElementById('setStatus');
      const gyroTempoLabel = document.getElementById('gyroTempoLabel');
      const gyroBars = document.querySelectorAll('#gyroChart .bar');

      // Hover handlers for bars
      gyroBars.forEach((bar, index) => {
        bar.addEventListener('mouseenter', () => {
          const item = gyroHistory[index];
          if (item && item.repIndex != null) {
            if (item.tempoMs != null) {
              const seconds = (item.tempoMs / 1000).toFixed(2);
              gyroTempoLabel.textContent = `Rep ${item.repIndex} tempo: ${seconds}s`;
            } else {
              gyroTempoLabel.textContent = `Rep ${item.repIndex} tempo: N/A`;
            }
          } else {
            gyroTempoLabel.textContent = 'No rep data for this bar';
          }
        });

        bar.addEventListener('mouseleave', () => {
          gyroTempoLabel.textContent = 'Hover a bar to see rep tempo';
        });
      });

      // --- Reset Session button ---
      document.getElementById('resetBtn').addEventListener('click', () => {
        sessionStart = Date.now();
        gyroHistory = [];
        magHistory = [];
        activityLog = [];
        setActive = false;
        baseGyroTotal = currentGyroTotal;

        document.getElementById('gyroReps').textContent = '0';
        document.getElementById('totalReps').textContent = '0';
        document.getElementById('avgMag').textContent = '0.0';
        setStatusEl.textContent = 'Not in a set';
        startSetBtn.disabled = false;
        endSetBtn.disabled = true;

        updateChart('gyroChart', gyroHistory);

        document.getElementById('activityFeed').innerHTML = 
          '<div class="activity-item"><div class="activity-time">--:--:--</div><div class="activity-text">Session reset</div></div>';
      });

      // --- WebSocket to backend ---
      (function connectWS() {
        ws = new WebSocket("ws://localhost:3000");

        ws.onopen = () => {
          console.log("WS connected");
          addActivity("Connected to sensor");
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);

            // Special rep_event messages from the server (one per completed rep)
            if (data.type === "rep_event") {
              const tempoMs = data.tempo_ms;
              const repIndex = data.rep_index ?? null;

              // Always create a bar, even if tempoMs is null (first rep)
              const height = tempoToHeight(tempoMs);
              gyroHistory.push({ height, tempoMs: (typeof tempoMs === "number" ? tempoMs : null), repIndex });
              if (gyroHistory.length > 10) gyroHistory.shift();

              updateChart("gyroChart", gyroHistory);

              if (repIndex != null) {
                if (typeof tempoMs === "number") {
                  addActivity(`Rep ${repIndex} tempo: ${tempoMs} ms`);
                } else {
                  addActivity(`Rep ${repIndex} tempo: N/A`);
                }
              }

              return; // don't treat this as a sensor frame
            }

            // Normal sensor frame: { t_ms, amag, gyro_reps }
            const mag = data.amag;

            currentGyroTotal  = data.gyro_reps ?? 0;

            const gyroSetReps = setActive
              ? Math.max(0, currentGyroTotal - baseGyroTotal)
              : 0;

            document.getElementById("gyroReps").textContent  = gyroSetReps;
            document.getElementById("totalReps").textContent = gyroSetReps;

            magHistory.push(mag);
            if (magHistory.length > 50) magHistory.shift();
            const avgMag = magHistory.reduce((a, b) => a + b, 0) / magHistory.length;
            document.getElementById("avgMag").textContent = avgMag.toFixed(2);

            document.getElementById("meta").textContent = 
              `t=${data.t_ms}ms  |  mag=${mag.toFixed(3)}  |  updated ${new Date().toLocaleTimeString()}`;

          } catch (e) {
            console.error("Bad message", event.data);
          }
        };

        ws.onclose = () => {
          console.log("WS closed, retrying in 2s");
          addActivity("Disconnected from sensor");
          setTimeout(connectWS, 2000);
        };
      })();

      // --- Set control buttons ---
      startSetBtn.addEventListener('click', () => {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          console.warn("WS not ready, cannot start set");
          addActivity("Cannot start set: not connected");
          return;
        }
        if (setActive) return;

        setActive = true;
        baseGyroTotal  = currentGyroTotal;
        gyroHistory = [];
        updateChart('gyroChart', gyroHistory);

        document.getElementById('gyroReps').textContent  = '0';
        document.getElementById('totalReps').textContent = '0';

        setStatusEl.textContent = 'Recording set...';
        startSetBtn.disabled = true;
        endSetBtn.disabled   = false;

        addActivity("Set started");

        ws.send(JSON.stringify({
          type: "start_set",
          client_ts: Date.now()
        }));
      });

      endSetBtn.addEventListener('click', () => {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          console.warn("WS not ready, cannot end set");
          addActivity("Cannot end set: not connected");
          return;
        }
        if (!setActive) return;

        const repsGyro  = Math.max(0, currentGyroTotal  - baseGyroTotal);
        const totalReps = repsGyro;

        setActive = false;

        document.getElementById('gyroReps').textContent  = '0';
        document.getElementById('totalReps').textContent = '0';

        setStatusEl.textContent =
          `Last set: ${repsGyro} gyro reps (${totalReps} total)`;

        startSetBtn.disabled = false;
        endSetBtn.disabled   = true;

        addActivity(`Set ended: ${repsGyro} gyro reps`);

        ws.send(JSON.stringify({
          type: "end_set",
          client_ts: Date.now(),
          reps_accel: 0,
          reps_gyro: repsGyro
        }));
      });

      // --- Webcam preview ---
      const cam = document.getElementById("cam");
      const camStatus = document.getElementById("camStatus");

      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices
          .getUserMedia({ video: { width: 1280, height: 720 } })
          .then((stream) => {
            cam.srcObject = stream;
            camStatus.textContent = "Streaming";
            addActivity("Camera connected");
          })
          .catch((err) => {
            camStatus.textContent = "Error: " + err.message;
            addActivity("Camera error");
          });
      } else {
        camStatus.textContent = "Camera not supported";
      }
    </script>

  </body>
</html>
